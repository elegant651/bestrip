
<dom-module id="register-schedule">
	<style>
		.wrapperDate {
			@apply(--layout-horizontal);			
		}

		.wrapperDate paper-input {
			margin-right: 20px;
		}

		paper-button.colorful {
			background: #4285f4;
      		color: #fff;
		}

		#btnRegister {
			margin-top: 20px;
		}
		
	</style>
	<template>		
		<firebase-collection	  
				id="fcSchedules"        
	          location="https://flamingo365.firebaseio.com/schedules"
	          data="{{schedules}}"></firebase-collection>

	    <firebase-document
	     	location="{{userTarget}}"
	     	data="{{userData}}"
	     	>
	     </firebase-document>

		<div class="vertical-section">
			<h3>{{user.facebook.displayName}}</h3>
		</div>
		<div class="vertical-section">
			<h2>City</h2>
			<paper-button id="btnSelCity" raised data-dialog="dlogCity" on-tap="showCityDlog">Select City<paper-button>	
		</div>
		<div class="vertical-section">
			<h2>Date</h2>			
			<div class="wrapperDate">
				<paper-input id="piStartDate" label="Select Start Date" on-tap="showStartDateDlog"></paper-input>
				<paper-input id="piFinishDate" label="Select Finish Date" on-tap="showFinishDateDlog"></paper-input>
			</div>
			<paper-date-picker-dialog id="datePicker" date="2015/8/8" on-value-changed="dateValueChanged"></paper-date-picker-dialog>
		</div>
		<div class="vertical-section">
			<h2>Theme</h2>
			<paper-radio-group selected="all">
				<paper-radio-button name="all">All</paper-radio-button>
				<paper-radio-button name="transport">Transport</paper-radio-button>
				<paper-radio-button name="stay">Stay</paper-radio-button>
				<paper-radio-button name="food">Food</paper-radio-button>
				<paper-radio-button name="sightsee">Sightsee</paper-radio-button>
			</paper-radio-group>
		</div>
		<div class="vertical-section">
			<h2>Contact</h2>
			<paper-input id="ipContact" label="phone number or facebook" maxlength="50" value="{{contact}}"></paper-input>
		</div>
		<div class="vertical-section">
			<paper-button id="btnRegister" raised disabled$="{{checkData(user, selCityIdx, startDate, finishDate, contact)}}" on-tap="register" class="colorful ripple"><iron-icon icon="check"></iron-icon>Register</paper-button>
		</div>
		<city-dialog id="cityDlog" on-select-city="onSelectCity"></city-dialog>
		
	</template>
</dom-module>
<script>
	Polymer({
		is: "register-schedule",

		properties: {
			user: {
				type: Object,
				value: null,
				observer: '_userChanged'				
			},

			userTarget: {
				type: String,
				computed: 'computeUserTarget(user.uid)'
			},

			dlogType: Number,
			selCityIdx: {
				type: Number,
				value: -1
			},

			startDate: {
				type: Number,
				value: -1
			},

			finishDate: {
				type: Number,
				value: -1
			},

			contact: {
				type: String,
				value: null
			}
		},		

		ready: function() {
			this.cityNames = [	
				{name: 'All', idx: 0},			
				{name: 'London', idx: 1},
				{name: 'Paris', idx: 2},
				{name: 'Berlin', idx: 3},
				{name: 'Rome', idx: 4},
				{name: 'Istanbul', idx: 5},
				{name: 'Prague', idx: 6}
			];
		},		

		_userChanged: function() {
			if(this.user!=null){
				this.contact = this.user.facebook.cachedUserProfile.link;	
			}			
		},		

		computeUserTarget: function(userId) {			
			return "https://flamingo365.firebaseio.com/users/"+userId;
		},

		showCityDlog: function() {						
			this.$.cityDlog.toggle();					
		},

		showStartDateDlog: function() {
			this.dlogType = 0;
			this.$.datePicker.toggle();
		},

		showFinishDateDlog: function() {
			this.dlogType = 1;
			this.$.datePicker.toggle();
		},		

		dateValueChanged: function() {
			console.log("dateValueChanged:" + this.$.datePicker.value);			
			var date = this.$.datePicker.value;
			var year = Intl.DateTimeFormat(this.locale, { year: 'numeric' }).format(date);
			var month = Intl.DateTimeFormat(this.locale, { month: 'short' }).format(date);
			var day = Intl.DateTimeFormat(this.locale, { day: 'numeric' }).format(date);
			
			var strDate = year+" "+month+" "+day;			
    		if(this.dlogType==0){
    			this.$.piStartDate.setAttribute("value", strDate);
    			this.startDate = date.getTime();    			
    		} else {
    			this.$.piFinishDate.setAttribute("value", strDate);
    			this.finishDate = date.getTime();
    		}
		},

		onSelectCity: function(e) {			
			this.selCityIdx = e.detail.idx;
			var strName = e.detail.name;
			this.$.btnSelCity.innerHTML = strName;
		},		

		checkData: function(user, selCityIdx, startDate, finishDate, contact) {			
			if(this.user==null){
				return true;
			}
			if(this.selCityIdx==-1){
				return true;
			}
			if(this.startDate==-1){
				return true;				
			}
			if(this.finishDate==-1){
				return true;
			}
			if(this.$.ipContact.value==null || this.$.ipContact.value===""){
				return true;
			}

			return false;
		},	

		register: function() {
			var schedule_title = this.$.piStartDate.getAttribute("value") + " ~ " + this.$.piFinishDate.getAttribute("value") + " : " + this.cityNames[this.selCityIdx].name;

			var data = {
				userid: this.user.uid,
				username: this.user.facebook.displayName,
				userlink: this.user.facebook.cachedUserProfile.link,
				userpic: this.user.facebook.cachedUserProfile.picture.data.url,
				selCityIdx: this.selCityIdx,
				startDate: this.startDate,
				finishDate: this.finishDate,
				schedule_title : schedule_title,
				contact: this.contact,
				created_at: new Date().getTime(),
				status: 0				
			};
			this.$.fcSchedules.add(data);

			//changing user status data
			this.userData.status = 1;
			this.notifyPath('userData.status', this.userData.status);
			this.isfindingdnable = true;

			this.fire('show-dialog', {content: "Registration has completed."});
		}
	});
</script>