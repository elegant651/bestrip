
<dom-module id="login-dialog">
	<style>
		:host {
			width: 500px;
			height: 300px;
			max-height: 300px;
			background: rgb(255,255,255);			
		}		

		.loginWrapper {
			@apply(--layout-horizontal);
			cursor: pointer;
		}

		.logoutWrapper {
			@apply(--layout-horizontal);
			cursor: pointer;
		}
	</style>
	<template>
		<firebase-auth id="firebaseLogin" user="{{user}}" status-known="{{statusKnown}}" location="https://flamingo365.firebaseio.com" provider="{{provider}}" on-error="errorHandler" on-user-created="userSuccessHandler" on-password-changed="userSuccessHandler" on-password-reset="userSuccessHandler" on-user-removed="userSuccessHandler"></firebase-auth>

		<div class="vertical-section">
			<div class="loginWrapper" on-tap="facebookLogin" hidden$="{{computeLoginHidden(statusKnown, user)}}">
				<iron-image src="../../images/main/facebook_btn.png" style="width:100px; height:100px;"></iron-image>
				<span>Facebook Login</span>
			</div>

			<div class="logoutWrapper" on-tap="logout" hidden$="{{computeLogoutHidden(statusKnown, user)}}">
				<iron-image src="../../images/main/facebook_btn.png" style="width:100px; height:100px;"></iron-image>
				<span>Facebook Logout</span>
			</div>

			<h3>Login status:</h3>
	    	<p>{{computeLoginStatus(statusKnown, user)}}</p>

	    	<h3>User ID:</h3>
	    	<pre>{{user.uid}}</pre>	    	
		</div>
	</template>
</dom-module>
<script>
	Polymer({
		is: "login-dialog",

		properties: {
			provider: {
				type: String,
				value: 'facebook'
			},

			message: {
	        	type: String,
	        	value: ''
	      	},

			user: {
	        	type: Object,
	        	value: null,
	        	observer: '_userChanged',
	        	notify: true
	      	},

	      	statusKnown: {
	        	type: Boolean
	      	}				      	
		},

		behaviors: [
	      Polymer.PaperDialogBehavior
	    ],

	    facebookLogin: function() {
	    	var params = null;
	    	this.$.firebaseLogin.login(params);
	    },

	    logout: function() {
	    	this.$.firebaseLogin.logout();
	    	this.fire('logout-complete', {userid: null}, {bubbles: true});	    		
	    	this.toggle();
	    },

	    errorHandler: function(e) {
	      this.message = 'Error: ' + e.detail.message;
	      console.log(this.message);
	    },

	    userSuccessHandler: function(e) {
	      this.message = e.type + ' success!';
	      console.log(this.message);
	    },

	    computeLoginHidden: function(statusKnown, user) {
	      return !statusKnown || !!user;
	    },

	    computeLogoutHidden: function(statusKnown, user) {
	      return !statusKnown || !user;
	    },

	    computeLoginStatus: function(statusKnown, user) {
	      if (statusKnown && user) {
	        return 'Logged in';
	      }

	      if (statusKnown) {
	        return 'Logged out';
	      }

	      return 'Unknown (checking status...)';
	    },

	    _userChanged: function() {
	    	if (this.statusKnown && this.user) {	   	    	
	    			
	    		var status;    		
	    		var ref = new Firebase("https://flamingo365.firebaseio.com/users");	    			 
	    		ref.child(this.user.uid).on("value", function(snapshot) {
	    			var userdata = snapshot.val();	    				    			
	    			status = userdata.status;
	    		}, function(error){
	    			console.log("error:" + error.code);
	    		});

				ref.child(this.user.uid).set({
					provider: this.user.provider,
					recent_at: new Date().getTime(),
					status: status 					
				});	    				    						

	    		console.log("logging in :"+this.user.uid+"/"+this.user.facebook.displayName+"/"+this.user.facebook.cachedUserProfile.link+"/"+this.user.facebook.cachedUserProfile.picture.data.url);
	    		
	    		
	    		this.fire('login-complete', {userid: this.user.uid}, {bubbles: true});	    		
	    		this.close();
	    	}
	    }
	});
</script>
