
<dom-module id="my-schedule">
	<style>
		h2 {
			text-align: center;
			font-size: 16px;			
		}

		hr {
			border: 0;
		    height: 1px;
		    background: rgb(200,200,200);
		    background-image: linear-gradient(to right, #ccc, #333, #ccc);
		    margin-top: 20px;
		}

		.list-element {
			width: 100%;			
						
		}

		.title {
			font-size: 15px;
			font-weight: bold;
		}

		.listWrapper {			

		}

		.usersWrapper {
			@apply(--layout-horizontal);			
		}

		.usersWrapper .userpic {
			cursor: pointer;
		}

		.userbox {
			width: 110px;			
			text-align: center;
			font-size: 13px;
		}

		.userbox .icHost {
			left: 18px;
    		top: -80px;
		}

		.userbox .icGender {
			margin-right: 5px;
		}

		.userbox .username {
			line-height: 20px;

		}

		.userbox .infos {
			@apply(--layout-horizontal);
			margin-left: 10px;				
		}

		.buttons {
			text-align: center;			
		}
	</style>
	<template>

	    <firebase-document
	     	location="{{scheduleTarget}}"
	     	data="{{scheduleData}}"
	     	>
	     </firebase-document>	     
		
		<div class="vertical-section">
			<template is="dom-repeat" items="[[schedules]]" sort="_sort" filter="filterOutdated" as="schedule"> 				
				<div class="list-element">					
					<h2>{{schedule.schedule_title}}</h2>
					<div class="listWrapper">
						<div class="usersWrapper">							
							<div class="userbox">
								<iron-icon class="icHost" src="../../images/main/host_icon.png"></iron-icon>								
								<iron-image class="userpic" src="{{schedule.userpic}}" sizing="cover" style="width:70px; height:70px;" data-userid$="{{schedule.userid}}" on-tap="moveProfile"></iron-image>
								<div class="infos">
									<iron-icon class="icGender" src="{{_computeUserGender(schedule.usergender)}}"></iron-icon>									
									<div class="username">{{schedule.username}}</div>
								</div>
							</div>							

							<template is="dom-repeat" items="{{arrayify(schedule.req_users)}}" as="requser">						
								<div class="userbox">
									<iron-image class="userpic" src="{{requser.userpic}}" sizing="cover" style="width:70px; height:70px;" data-userid$="{{requser.userid}}" on-tap="moveProfile"></iron-image>
									<div class="infos">
										<iron-icon class="icGender" src="{{_computeUserGender(requser.usergender)}}"></iron-icon>
										<div class="username">{{requser.username}}</div>
									</div>
									
									<paper-button data-userid$="{{requser.userid}}" raised
									on-tap="showContact" hidden$="{{isShowContact(schedule.status)}}" class="colorful ripple">Show Contact</paper-button>
								</div>								
							</template>
						</div>

						<div class="buttons">							
							<paper-button id="btnMakeTeam" on-tap="makeTeam" 
								data-scheduleid$="{{schedule.__firebaseKey__}}" raised
								hidden$="{{showMakeTeamButton(schedule.status)}}" class="colorful ripple"><iron-icon icon="check"></iron-icon>Set team</paper-button>
						</div>
					</div>
				</div>
			</template>
		</div>

		<hr />

		<div class="vertical-section">			 
			<template is="dom-repeat" items="[[requests]]" as="request"> 
				
				<div class="list-element">					
					<h2>{{request.schedule_title}}</h2>

					<div class="listWrapper">
						<div class="usersWrapper">													
							<div class="userbox">
								<iron-icon class="icHost" src="../../images/main/host_icon.png"></iron-icon>								
								<iron-image class="userpic" src="{{request.schedule_userpic}}" sizing="cover" style="width:70px; height:70px;" data-userid$="{{request.schedule_userid}}" on-tap="moveProfile"></iron-image>
								<div class="infos">
									<iron-icon class="icGender" src="{{_computeUserGender(request.schedule_usergender)}}"></iron-icon>
									<div class="username">{{request.schedule_username}}</div>
								</div>								
							</div>														
						</div>						
					</div>
				</div>
			</template>
		</div>


		<contact-dialog id="contactDlog" userid="{{selUserId}}"></contact-dialog>
	</template>
</dom-module>
<script>
	Polymer({
		is: "my-schedule",

		properties: {
			userid: {
				type: String,				
				observer: '_useridChanged'
			},

			scheduleId: Number,

			// userData: {
			// 	type: Object,
			// 	observer: '_userDataChanged'
			// },

			schedules: Object,

			requests: Object,

			scheduleTarget: {
				type: String,
				computed: 'computeScheduleTarget(scheduleId)'
			},

			selUserId: String			
		},

		_useridChanged: function() {
			if(this.userid!=""){			
				var that = this;						 
				// var ref = new Firebase("https://flamingo365.firebaseio.com/users");	    
				// ref.child(this.userid).once("value", function(snap) {						
				// 	that.userData = snap.val();					
				// });
			
				var scheduleRef = new Firebase("https://flamingo365.firebaseio.com/schedules");
				scheduleRef.orderByChild("userid").equalTo(this.userid).on("value", function(querySnapshot){
					that.schedules = [];
					querySnapshot.forEach(function(snapshot){
						var sv = snapshot.val();
						sv["__firebaseKey__"] = snapshot.key();									
						that.push("schedules", sv);									
					});
				});
	
				var reqRef = new Firebase("https://flamingo365.firebaseio.com/requests");
				reqRef.orderByChild("userid").equalTo(this.userid).on("value", function(querySnapshot){
					that.requests = [];
					querySnapshot.forEach(function(snapshot){
						var sv = snapshot.val();
						sv["__firebaseKey__"] = snapshot.key();									
						that.push("requests", sv);														
					});
				});
			}	
		},

		_userDataChanged: function() {			
			// if(this.userData.numMT!=this.requests.length){
			// 	console.log("differentMT");

			// 	var ref = new Firebase(this.userTarget);
			// 	ref.update({
			// 		"numMT": this.requests.length
			// 	});

			// 	this.userData.numMT = this.requests.length;
		 //  		this.notifyPath('userData.numMT', this.userData.numMT);

		 //  		this.fire('show-newflag');
		 // 	} else {
		 // 		this.fire('hide-newflag');
		 // 	}
		},

		_sort: function(a, b) {			
			return a.startDate > b.startDate ? 1 : -1;
		},

		filterOutdated: function(item) {
			return item.startDate >= new Date().getTime();
		},

		computeScheduleTarget: function(scheduleId) {
			return "https://flamingo365.firebaseio.com/schedules/"+scheduleId;
		},
		
		_computeUserGender: function(gender) {
			if(gender==="male"){
				return "../../images/main/male_imae.png";
			} else {
				return "../../images/main/female_imae.png";
			}
		},

		moveProfile: function(e) {
			var userid = e.currentTarget.getAttribute("data-userid");
			page.redirect("/myprofile/"+userid);
		},

		arrayify: function(obj) { 		
			if(obj==null) return null;

			var that = this;
			var arr = Object.keys(obj).map(function(k) { 			 
			 return obj[k]; 
			});
			
			return arr;
		},

		isShowContact: function(status) {
			if(status==0){
				return true;
			} else {
				return false;
			}
		},

		showMakeTeamButton: function(status) {
			if(status==0){
				return false;
			} else {
				return true;
			}
		},		

		makeTeam: function(e) {
			this.scheduleId = e.currentTarget.getAttribute("data-scheduleid");

			console.log(this.scheduleId+"///");
			return;

			if(this.scheduleId!=null){
				this.scheduleData.status = 1;
				this.notifyPath('scheduleData.status', this.scheduleData.status);

				this.fire('show-dialog', {content: "The task has completed.", url: "/myschedule"});
			}
		},

		showContact: function(e) {
			this.selUserId = e.currentTarget.getAttribute("data-userid");			

			if(this.selUserId!=null) {
				this.$.contactDlog.toggle();
			}
		}
	});
</script>