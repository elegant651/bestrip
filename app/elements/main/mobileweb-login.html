
<dom-module id="mobileweb-login">
	<style>
		#moBtnSignup {
			position: fixed;
			right: 30px;
			top: 30px;
			cursor: pointer;
		}

		.moHeader {
			background-image: url("../../images/main/main_image.jpg");
			background-size: cover;
			background-repeat: no-repeat;	
			height: 300px;
			text-align: center;
		}

		.moHeader .title {
			color: rgb(254,254,254);
			font-size: 55px;
			padding-top: 100px;
		}

		.moHeader .subtitle {
			color: rgb(254,254,254);
			font-size: 25px;
			font-weight: lighter;
			margin-top: 20px
		}

		.moBody {
			text-align: center;
		}		

		#moBtnFacebook {	
			margin-top: 10px;	
			cursor: pointer;
		}

		#moBtnLogin {			
			margin-top: 20px;
			cursor: pointer;
		}
	</style>
	<template>
		<firebase-auth id="firebaseLogin" user="{{user}}" status-known="{{statusKnown}}" location="https://flamingo365.firebaseio.com" provider="{{provider}}" on-error="errorHandler"></firebase-auth>

		<div id="moWrapper">
			<iron-image id="moBtnSignup" src="../../images/main/main_signup_btn.png" on-tap="moveSignup"></iron-image>
          	<div class="moHeader"><div class="title">FLAMINGO</div><div class="subtitle">Find traveler at once</div></div>
          	<div class="moBody">
            	<div><iron-image id="moBtnFacebook" src="../../images/main/facebook.png" on-tap="facebookLogin"></iron-image></div>
            	<div><iron-image src="../../images/main/main_or.png"></iron-image></div>
            	<div><input placeholder="email" value="{{email::input}}"></div>
            	<div><input placeholder="password" value="{{password::input}}"></div>          

            	<div><iron-image id="moBtnLogin" disabled$="{{computeLogin(email,password)}}" src="../../images/main/main_login_btn.png" on-tap="emailLogin"></iron-image></div>
          	</div>
        </div>        
	</template>
</dom-module>
<script>
	Polymer({
		is: "mobileweb-login",

		properties: {
			provider: {
				type: String,
				value: 'facebook',
				notify: true
			},

			message: {
	        	type: String,
	        	value: ''
	      	},

	      	email: {
	        	type: String,
	        	value: ''
	      	},

	      	password: {
	        	type: String,
	        	value: ''
	      	},	      	

			user: {
	        	type: Object,
	        	value: null,
	        	observer: '_userChanged',
	        	notify: true
	      	},

	      	statusKnown: {
	        	type: Boolean
	      	}				      	
		},

		moveSignup: function() {
			page.redirect('/signup');
		},

		facebookLogin: function() {
			this.provider = "facebook";
	    	var params = null;
	    	this.$.firebaseLogin.login(params);
		},

		computeLogin: function(email, password) {
			if(this.email==null || this.password==null || this.email=='' || this.password==''){
				return true;
			}

			return false;
		},

		emailLogin: function() {	
			if(this.email==null || this.password==null || this.email=='' || this.password==''){
				console.log("email or password incorrect");
				return;
			}

			this.provider = "password";
	    	var params;

	      	try {
	        	params = JSON.parse(this.params);
	      	} catch (e) {
	       		params = null;
	      	}
	      	
	        params = params || {};
	        params.email = this.email;
	        params.password = this.password;
	      
	      	this.$.firebaseLogin.login(params);
		},

		errorHandler: function(e) {
	      this.message = 'Error: ' + e.detail.message;
	      console.log(this.message);
	    },

	    _userChanged: function() {

	    	if (this.statusKnown && this.user) {	   	    		    				    	    		    				    		
	    		if(this.provider=="facebook"){
	    			console.log("logging in :"+this.user.uid+"/"+this.user.facebook.displayName+"/"+this.user.facebook.cachedUserProfile.link+"/"+this.user.facebook.cachedUserProfile.gender+"/"+this.user.facebook.cachedUserProfile.picture.data.url);

	    			var that = this;
	    			var ref = new Firebase("https://flamingo365.firebaseio.com/users");	  
	    				    			

	    			ref.once('value', function(snapshot) {
	    				if(snapshot.hasChild(that.user.uid)){	    					
	    					ref.child(that.user.uid).child("status").once('value', function(snapshot){
			    				console.log("status:"+snapshot.val());
			    				var status = snapshot.val();
			    				if(status!=1){

			    					// go to signup page
			    					console.log("go to signup page with provider");						
			    					page.redirect('/signup');
			    				}  else {

			    					console.log("login complete");			    					
			    					page.redirect('/register');
			    				}
			    			});	    												
	    				} else {
	    					ref.child(that.user.uid).set({
								provider: "facebook",
								username: that.user.facebook.displayName,
								gender: that.user.facebook.cachedUserProfile.gender,
								picture: that.user.facebook.cachedUserProfile.picture.data.url,
								link: that.user.facebook.cachedUserProfile.link,						
								status: 0						
							});	

	    					/// go to signup page    	
	    					console.log("go to signup page with provider");	    					
	    					page.redirect('/signup');
	    				}
	    			});	    			

	    		} else {
	    			console.log("login complete");
	    			// that.fire('login-complete', {userid: that.user.uid}, {bubbles: true});
	    			page.redirect('/register');

	    		}	    		
	    			    		    			    			    		
	    	} else {	    		

	    		if(window.location.hash!==""){
	    			console.log("tt");
	    			// location.href = "/";
	    		}	    		
	    	}
	    }
	});
</script>
