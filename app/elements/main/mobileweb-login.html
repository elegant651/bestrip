
<dom-module id="mobileweb-login">
	<style>		
		#moBtnSignup {
			position: fixed;
			right: 30px;
			top: 30px;
			cursor: pointer;
		}

		.moHeader {
			background-image: url("../../images/main/main_image.jpg");
			background-size: cover;
			background-repeat: no-repeat;	
			height: 300px;
			text-align: center;
		}

		.moHeader .title {
			color: rgb(254,254,254);
			font-size: 55px;
			padding-top: 100px;
		}

		.moHeader .subtitle {
			color: rgb(254,254,254);
			font-size: 25px;
			font-weight: lighter;
			margin-top: 20px
		}

		.moBody {
			text-align: center;
		}		

		.moBody input {
			width: 220px;
			height: 45px;
			font-size: 20px;
			padding-left: 10px;
			text-align: center;
		}

		.moBody .icField {
			top: -40px;
    		left: -90px;    		
		}

		.moBody .moField {
			width: 230px;
			height: 45px;
			text-align: center;
			margin: 0 auto;
			margin-bottom: 10px;
		}

		#moBtnFacebook {	
			margin-top: 10px;	
			cursor: pointer;
		}

		#moBtnLogin {			
			margin-top: 20px;
			cursor: pointer;
		}
	</style>
	<template>
		<firebase-auth id="firebaseLogin" user="{{user}}" status-known="{{statusKnown}}" location="https://flamingo365.firebaseio.com" provider="{{provider}}" on-error="errorHandler"></firebase-auth>

		<div id="moWrapper">
			<iron-image id="moBtnSignup" src="../../images/main/main_SIGN-UP_btn.png" on-tap="moveSignup"></iron-image>
          	<div class="moHeader"><div class="title">FLAMINGO</div><div class="subtitle">Find traveler at once</div></div>
          	<div class="moBody">
            	<div><iron-image id="moBtnFacebook" src="../../images/main/facebook.png" on-tap="facebookLogin"></iron-image></div>
            	<div style="color:rgb(129,129,129); margin: 5px;">or</div>
            	<div class="moField"><input placeholder="email" value="{{email::input}}" /><iron-icon class="icField" src="../../images/main/main_email_icon.png"></iron-icon></div>
            	<div class="moField"><input placeholder="password" type="password" value="{{password::input}}" /><iron-icon class="icField" src="../../images/main/main_password_icon.png"></iron-icon></div>          

            	<div><paper-button id="moBtnLogin" disabled$="{{computeLogin(email,password)}}" on-tap="emailLogin"><iron-image src="../../images/main/main_login_btn.png"></iron-image></paper-button></div>
          	</div>
        </div>        
	</template>
</dom-module>
<script>
	Polymer({
		is: "mobileweb-login",

		properties: {
			route: String,

			provider: {
				type: String,
				value: 'password',
				notify: true
			},

			message: {
	        	type: String,
	        	value: ''
	      	},

	      	email: {
	        	type: String,
	        	value: ''
	      	},

	      	password: {
	        	type: String,
	        	value: ''
	      	},	      	

			user: {
	        	type: Object,
	        	value: null,
	        	observer: '_userChanged',
	        	notify: true
	      	},

	      	statusKnown: {
	        	type: Boolean
	      	}				      	
		},

		ready: function() {

		},

		moveSignup: function() {
			page.redirect('/signup');
		},

		facebookLogin: function() {
			this.provider = "facebook";
	    	var params = null;
	    	this.$.firebaseLogin.login(params);
		},

		computeLogin: function(email, password) {
			if(this.email==null || this.password==null || this.email=='' || this.password==''){
				return true;
			}

			return false;
		},

		emailLogin: function() {	
			if(this.email==null || this.password==null || this.email=='' || this.password==''){
				console.log("email or password incorrect");
				return;
			}

			this.provider = "password";
	    	var params;

	      	try {
	        	params = JSON.parse(this.params);
	      	} catch (e) {
	       		params = null;
	      	}
	      	
	        params = params || {};
	        params.email = this.email;
	        params.password = this.password;
	      
	      	this.$.firebaseLogin.login(params);
		},

		errorHandler: function(e) {
	      this.message = 'Error: ' + e.detail.message;
	      console.log(this.message);
	      alert(this.message);
	    },

	    _userChanged: function() {
	    	if(this.user){
	    		console.log("user:"+JSON.stringify(this.user));
	    	}

	    	if(this.user && this.route=="home"){	    		
	    		// page.redirect("/register");
	    		// return;
	    	}
	    	
	    	if (this.statusKnown && this.user) {	   	    		    				 	    	
	    		if(this.provider=="facebook"){
	    			console.log("logging in :"+this.user.uid+"/"+this.user.facebook.displayName+"/"+this.user.facebook.cachedUserProfile.link+"/"+this.user.facebook.cachedUserProfile.gender+"/"+this.user.facebook.cachedUserProfile.picture.data.url);

	    			var that = this;
	    			var ref = new Firebase("https://flamingo365.firebaseio.com/users");	  
	    				    			

	    			ref.once('value', function(snapshot) {
	    				if(snapshot.hasChild(that.user.uid)){	    					
	    					ref.child(that.user.uid).once('value', function(snapshot){			    				
			    				var status = snapshot.child("status").val();
			    				if(status!=1){

			    					// go to signup page
			    					console.log("go to signup page with provider");						
			    					page.redirect('/signup');
			    				}  else {

			    					// that.setUserData(snapshot);
			    					console.log("login complete");			    					
			    					page.redirect('/register');
			    				}
			    			});	    												
	    				} else {
	    					ref.child(that.user.uid).set({
								provider: "facebook",
								username: that.user.facebook.displayName,
								gender: that.user.facebook.cachedUserProfile.gender,
								picture: that.user.facebook.cachedUserProfile.picture.data.url,
								link: that.user.facebook.cachedUserProfile.link,						
								status: 0						
							});	

	    					/// go to signup page    	
	    					console.log("go to signup page with provider");	    					
	    					page.redirect('/signup');
	    				}
	    			});	    			

	    		} else {
	    			// var ref = new Firebase("https://flamingo365.firebaseio.com/users");
	    			// var that = this;
	    			// ref.child(this.user.uid).once('value', function(snapshot){
	    			// 	that.setUserData(snapshot);

	    				console.log("login complete");	    			
	    				page.redirect('/register');
	    			// });	    			
	    		}	    		
	    			    		    			    			    		
	    	} else {	    		

	    		if(window.location.hash!==""){
	    			// console.log("tt");
	    			// location.href = "/";
	    		}	    		
	    	}
	    }
	});
</script>
