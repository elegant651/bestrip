
<dom-module id="finding-travelers">
	<style>
		.searchWrapper {
			@apply(--layout-horizontal);
		}

		.wrapperDate {
			@apply(--layout-horizontal);			
		}

		.wrapperDate paper-input {
			margin-right: 20px;
		}

		#btnSearch {
			margin-top: 60px;
		}

		.travelBox {
			@apply(--layout-horizontal);	
			@apply(--layout-justified);	
		}
		
	</style>
	<template>
		<firebase-collection	  
				id="fcSchedules"        
	          location="https://flamingo365.firebaseio.com/schedules"
	          data="{{schedules}}"></firebase-collection>

	    <firebase-collection	  
				id="fcRequests"        
	          location="https://flamingo365.firebaseio.com/requests"
	          ></firebase-collection>
	    
	    <div hidden$="{{isShow}}">
			<paper-material elevation="1">
				<div class="searchWrapper">
					<div class="vertical-section">
						<h2>City</h2>
						<paper-button id="btnSelCity" data-dialog="dlogCity" on-tap="showCityDlog">Select City<paper-button>
					</div>
					<div class="vertical-section">
						<h2>Date</h2>
						<div class="wrapperDate">
							<paper-input id="piPickDate" label="Select Date" on-tap="showDateDlog"></paper-input>
						</div>				
					</div>

					<paper-button id="btnSearch" raised on-tap="search" class="colorful ripple"><iron-icon icon="search"></iron-icon>Search</paper-button>				
				</div>
			</paper-material>


			<div class="vertical-section">			

				<template is="dom-repeat" items="[[schedules]]" as="schedule">
					<h2>{{schedule.schedule_title}}</h2>				
					<div class="travelBox">
						<iron-image src="[[schedule.userpic]]" style="width:100px; height:100px;"></iron-image>
						<div class="name">[[schedule.username]]</div>
						<paper-fab id="btnRequest" disabled$="{{checkData(user)}}" on-tap="request" data-key$="{{schedule.__firebaseKey__}}" data-schedule-userid$="{{schedule.userid}}"
						data-schedule-userlink$="{{schedule.userlink}}" data-schedule-username$="{{schedule.username}}"
						data-schedule-userpic$="{{schedule.userpic}}"
						 data-schedule-title$="{{schedule.schedule_title}}" icon="arrow-forward"></paper-fab>
					</div>				
				</template>				
			</div>
		</div>

		<city-dialog id="cityDlog" on-select-city="onSelectCity"></city-dialog>
		<paper-date-picker-dialog id="datePicker" date="2015/8/8" on-value-changed="dateValueChanged"></paper-date-picker-dialog>		

		<div hidden$="{{!isShow}}">			
			<h2>To viewing this page, Go to register your schedule!!</h2>
		</div>

	</template>
</dom-module>
<script>
	Polymer({
		is: "finding-travelers",

		properties: {			
			schedules: Object,
			user: {
				type: Object,
				value: null,
				observer: '_userChanged'
			},

			selCityIdx: {
				type: Number,
				value: -1
			},

			pickDate: {
				type: Number,
				value: -1
			},

			isShow: {
				type: Boolean,
				value: false				
			}
		},

		_userChanged: function() {
			///check if user's status is 1
			if(this.user){
				var that = this;
				var ref = new Firebase("https://flamingo365.firebaseio.com/users");	    			 
	    		ref.child(this.user.uid).on("value", function(snapshot) {
	    			var userdata = snapshot.val();	    				    			    			
	    			if(userdata.status==1){
	    				that.isShow = false;    				
	    			} else {
	    				that.isShow = true;
	    			}
	    		}, function(error){
	    			console.log("error:" + error.code);
	    		});	    		
			}			
		},

		showCityDlog: function() {			
			this.$.cityDlog.toggle();
		},

		showDateDlog: function() {			
			this.$.datePicker.toggle();
		},

		dateValueChanged: function() {			
			var date = this.$.datePicker.value;
			var year = Intl.DateTimeFormat(this.locale, { year: 'numeric' }).format(date);
			var month = Intl.DateTimeFormat(this.locale, { month: 'short' }).format(date);
			var day = Intl.DateTimeFormat(this.locale, { day: 'numeric' }).format(date);
			
			var strDate = year+" "+month+" "+day;
			this.$.piPickDate.setAttribute("value", strDate);
			this.pickDate = date.getTime();    			    		
		},

		onSelectCity: function(e) {			
			this.selCityIdx = e.detail.idx;
			var strName = e.detail.name;
			this.$.btnSelCity.innerHTML = strName;			
		},		

		search: function() {
			var selCityIdx = this.selCityIdx;
			var pickDate = this.pickDate;
			var that = this;
			
			if(selCityIdx!=-1 && pickDate!=-1){
				var ref = new Firebase("https://flamingo365.firebaseio.com/schedules");								
				ref.orderByChild("selCityIdx").equalTo(selCityIdx).on("value", function(querySnapshot) {					
					
					that.schedules = [];				
					querySnapshot.forEach(function(snapshot) {						
						if(snapshot.val().startDate <= pickDate && pickDate <= snapshot.val().finishDate){
							// objSchedule = snapshot;										
							var sv = snapshot.val();							
							sv["__firebaseKey__"] = snapshot.key();					
							// that.schedules.push(sv);
							that.push('schedules', sv);
						}
					});									
				});
				
			}			
		},

		checkData: function(user) {
			if(this.user==null){
				return true;
			}

			return false;
		},

		request: function(e) {			
			var schedule_id = e.currentTarget.getAttribute("data-key");
			var schedule_title = e.currentTarget.getAttribute("data-schedule-title");
			var schedule_userid = e.currentTarget.getAttribute("data-schedule-userid");
			var schedule_username = e.currentTarget.getAttribute("data-schedule-username");
			var schedule_userlink = e.currentTarget.getAttribute("data-schedule-userlink");
			var schedule_userpic = e.currentTarget.getAttribute("data-schedule-userpic");			

			var data = {
				schedule_id: schedule_id,
				schedule_title: schedule_title,
				schedule_userid: schedule_userid,
				schedule_username: schedule_username,
				schedule_userlink: schedule_userlink,
				schedule_userpic: schedule_userpic,
				userid: this.user.uid,
				username: this.user.facebook.displayName,
				userlink: this.user.facebook.cachedUserProfile.link,
				userpic: this.user.facebook.cachedUserProfile.picture.data.url,
				status: 0,
				created_at: new Date().getTime()				
			};
			this.$.fcRequests.add(data);
			this.fire('show-dialog', {content: "Request has sent."});
		}
	});
</script>