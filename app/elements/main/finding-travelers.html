
<dom-module id="finding-travelers">
	<style>
		h2 {
			text-align: center;
			font-size: 15px;
			font-weight: normal;
		}

		.searchWrapper {			
			width: 100%;
			text-align: center;
			margin-top: 50px;
		}		

		.wrapperCity {
			@apply(--layout-horizontal);			
			@apply(--layout-center-justified);
		}		

		.wrapperCity .icCity {
			margin: 18px;
		}

		#btnSelCity {
			width: 150px;
			margin-top: 15px;			
		}		
		
		.wrapperDate {
			@apply(--layout-horizontal);			
			@apply(--layout-center-justified);
		}

		.wrapperDate .icDate {
			margin: 18px;
		}

		.wrapperDate paper-input {
			margin-right: 20px;
		}

		iron-selector > * {
        	padding: 8px;
        	width: 60px;
      	}

      	.iron-selected {
        	background-color: #ddd;
      	}		

      	#rgTheme {
			font-size: 13px;			
			@apply(--layout-horizontal);	
			@apply(--layout-center-justified);
		}

		#rgTheme .imgDining {
			background-image: url("../../images/main/dining_icon_1.png");
			background-size: cover;
			background-repeat: no-repeat;	
			width: 30px;
			height: 30px;
		}
		#rgTheme .iron-selected .imgDining {
			background-image: url("../../images/main/dining_icon_2.png");
		}

		#rgTheme .imgParty {
			background-image: url("../../images/main/party_icon_1.png");
			background-size: cover;
			background-repeat: no-repeat;	
			width: 30px;
			height: 30px;
		}
		#rgTheme .iron-selected .imgParty {
			background-image: url("../../images/main/party_icon_2.png");
		}

		#rgTheme .imgAccompany {
			background-image: url("../../images/main/accompany_icon_1.png");
			background-size: cover;
			background-repeat: no-repeat;	
			width: 30px;
			height: 30px;
		}
		#rgTheme .iron-selected .imgAccompany {
			background-image: url("../../images/main/accompany_icon_2.png");
		}

		#btnSearch {
			height: 60px;
			margin-top: 30px;
			margin-bottom: 30px;
		}

      	.search-result{
      		margin: 10px;
      		margin-top: 25px;
      	}

		.travelBox {
			@apply(--layout-horizontal);				
		}

		.travelBox .userinfoWrapper {
			@apply(--layout-horizontal);				
		}

		.travelBox .userinfoWrapper .icGender {
			margin-left: 15px;
			margin-right: 10px;
		}

		.travelBox .userinfoWrapper .name {
			margin-top: 3px;
		}
			
		.travelBox .themeWrapper {			
			@apply(--layout-horizontal);					
		}	

		.travelBox .themeWrapper .themes {
			margin: 15px;
		}

		.travelBox .themeWrapper #btnRequest {
			position: absolute;
			right: 15px;
		}
		
	</style>
	<template>

	    <firebase-collection	  
				id="fcRequests"        
	          location="https://flamingo365.firebaseio.com/requests"
	          ></firebase-collection>
	    	    
			<paper-material elevation="1">
				<div class="searchWrapper">
					<div class="vertical-section">
						<h2>City</h2>
						<div class="wrapperCity">
							<iron-icon class="icCity" src="../../images/main/nationality_icon.png"></iron-icon>
							<paper-button id="btnSelCity" data-dialog="dlogCity" on-tap="showCityDlog">Select<paper-button>
						</div>
					</div>
					<div class="vertical-section">											
						<h2>Date</h2>			
						<div class="wrapperDate">
							<iron-icon class="icDate" src="../../images/main/calendar_icon_2.png"></iron-icon>
							<paper-input id="piPickDate" label="Select Start Date" on-tap="showDateDlog"></paper-input>				
						</div>
					</div>

					<div class="vertical-section">
						<h2>Theme</h2>
						<paper-radio-group id="rgTheme" selected="party">
							<paper-radio-button name="dining"><div class="imgDining"></div>Dining</paper-radio-button>
							<paper-radio-button name="party"><div class="imgParty"></div>Party</paper-radio-button>
							<paper-radio-button name="accompany"><div class="imgAccompany"></div>Accompany</paper-radio-button>				
						</paper-radio-group>
					</div>
							

					<div class="vertical-section">
						<paper-button id="btnSearch" raised on-tap="search" class="colorful ripple"><iron-image src="../../images/main/searching_btn_2.png"></iron-image></paper-button>				
					</div>
				</div>
			</paper-material>

			<div class="vertical-section search-result">			

				<template is="dom-repeat" items="[[schedules]]" filter="filterStatus" sort="_sort" as="schedule">					
					<div class="travelBox">
						<iron-image src="[[schedule.userpic]]" style="width:100px; height:100px;"></iron-image>
						<div class="vertical-section">
							<div class="userinfoWrapper">
								<iron-icon class="icGender" src="{{_computeUserGender(schedule.usergender)}}"></iron-icon>
								<div class="name">[[schedule.username]]</div>
							</div>
							<div class="themeWrapper">
								<div class="themes"><iron-image src="{{_computeThemeImg(schedule.themeIdx)}}"></iron-image></div>								
								<paper-button id="btnRequest" on-tap="request" data-key$="{{schedule.__firebaseKey__}}" data-schedule-userid$="{{schedule.userid}}"
								data-schedule-userlink$="{{schedule.userlink}}" data-schedule-username$="{{schedule.username}}"
								data-schedule-userpic$="{{schedule.userpic}}"
								 data-schedule-title$="{{schedule.schedule_title}}">
								 	<iron-image src="../../images/main/request_btn.png"></iron-image>
								</paper-button>
							</div>							
						</div>
					</div>				
				</template>				
			</div>
		</div>		

		<city-dialog id="cityDlog" on-select-city="onSelectCity"></city-dialog>


		<paper-dialog id="dpDlog" class="paper-date-picker-dialog" on-iron-overlay-closed="dateValueChanged">
			<div class="buttons">
	          <paper-button dialog-dismiss>Cancel</paper-button>
	          <paper-button dialog-confirm>OK</paper-button>
	        </div>
	        <paper-date-picker id="datePicker" date="{{pickerDate}}" responsive-width="655px"></paper-date-picker>	        
	      </paper-dialog>
	</template>
</dom-module>
<script>
	Polymer({
		is: "finding-travelers",

		properties: {			
			schedules: Object,
			user: {
				type: Object,
				value: null				
			},

			selCityIdx: {
				type: Number,
				value: -1
			},		

			pickerDate: {
				type: Number,
				observer: '_pickerDateChanged'
			},	

			pickDate: {
				type: Number,
				value: -1
			},

			isShow: {
				type: Boolean,
				value: false				
			},

			themeIdx: {
				type: Number,
				value: 0
			}
		},

		ready: function() {			

			this.search();			
		},

		filterStatus: function(item) {			
			if(this.themeIdx==0){
				return item.status == 0;
			} else {
				return item.status == 0 && item.themeIdx == this.themeIdx;
			}			
		},

		_sort: function(a, b) {			
			return a.startDate > b.startDate ? 1 : -1;
		},
		
		showCityDlog: function() {			
			this.$.cityDlog.open();
		},

		showDateDlog: function() {			
			this.$.dpDlog.open();
		},

		
		_pickerDateChanged: function() {
			this.$.dpDlog.close();
			this.dateValueChanged();
		},

		dateValueChanged: function() {			
			var date = this.$.datePicker.date;
			if(this.$.datePicker.date==null){
				return;
			}
						
			var year = this.$.datePicker.dateFormat(date, 'YYYY');
			var month = this.$.datePicker.dateFormat(date, 'MMM');
			var day = this.$.datePicker.dateFormat(date, 'D');
			
			var strDate = year+" "+month+" "+day;

			this.$.piPickDate.value = strDate;
			this.pickDate = date.getTime();    			    		
		},

		onSelectCity: function(e) {			
			this.selCityIdx = e.detail.idx;
			var strName = e.detail.name;
			this.$.btnSelCity.innerHTML = strName;			
		},		
		
		search: function() {							
			var selCityIdx = this.selCityIdx;
			var pickDate = this.pickDate;			
			
			var that = this;
			
			var ref = new Firebase("https://flamingo365.firebaseio.com/schedules");					
			if(selCityIdx!=-1 && pickDate!=-1){						
				ref.orderByChild("selCityIdx").equalTo(selCityIdx).on("value", function(querySnapshot) {									
					that.schedules = [];				
					querySnapshot.forEach(function(snapshot) {						
						if(snapshot.val().startDate <= pickDate && pickDate <= snapshot.val().finishDate){
					// 		// objSchedule = snapshot;										
							var sv = snapshot.val();							
							sv["__firebaseKey__"] = snapshot.key();									
							that.push('schedules', sv);							
						}
					});									
				});							
			} else {
				ref.on("value", function(querySnapshot) {									
					that.schedules = [];				
					querySnapshot.forEach(function(snapshot) {						
						var sv = snapshot.val();							
						sv["__firebaseKey__"] = snapshot.key();					
						that.push('schedules', sv);							
					});
				});
			}			
		},

		_computeUserGender: function(gender) {
			if(gender==="male"){
				return "../../images/main/male_imae.png";
			} else {
				return "../../images/main/female_imae.png";
			}
		},

		_computeThemeImg: function(themeIdx) {
			if(themeIdx == 0){
				return "../../images/main/dining_icon.png";
			} else if(themeIdx == 1){
				return "../../images/main/party_icon.png";
			} else if(themeIdx == 2){
				return "../../images/main/accompany_icon.png";
			}
		},

		checkData: function(userid) {						
			if(this.user==null || this.user.uid==userid){
				return true;
			}

			return false;
		},

		request: function(e) {						
			var schedule_id = e.currentTarget.getAttribute("data-key");
			var schedule_title = e.currentTarget.getAttribute("data-schedule-title");
			var schedule_userid = e.currentTarget.getAttribute("data-schedule-userid");
			var schedule_username = e.currentTarget.getAttribute("data-schedule-username");
			var schedule_userlink = e.currentTarget.getAttribute("data-schedule-userlink");
			var schedule_userpic = e.currentTarget.getAttribute("data-schedule-userpic");			

			if(this.user==null || this.user.uid==schedule_userid){
				alert("It's impossible to request its user");
				return;
			}

			var data = {
				schedule_id: schedule_id,
				schedule_title: schedule_title,
				schedule_userid: schedule_userid,
				schedule_username: schedule_username,
				schedule_userlink: schedule_userlink,
				schedule_userpic: schedule_userpic,
				userid: this.user.uid,
				username: this.user.facebook.displayName,
				userlink: this.user.facebook.cachedUserProfile.link,
				userpic: this.user.facebook.cachedUserProfile.picture.data.url,
				status: 0,
				created_at: new Date().getTime()				
			};
			this.$.fcRequests.add(data);
			this.fire('show-dialog', {content: "Request has sent.",url: "/search"});
		}
	});
</script>