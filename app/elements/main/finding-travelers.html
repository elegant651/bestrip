<!-- <link rel="import" href="../dialogs/city-dialog.html"> -->
<!-- <link rel="import" href="../../bower_components/paper-date-picker/paper-date-picker.html"> -->

<dom-module id="finding-travelers">
	<style>
		h2 {
			text-align: center;
			font-size: 15px;
			font-weight: normal;
			margin: 3px;
		}

		.iron-selected {
			background-color: #fff;
		}

		hr {
			border: 0;
		    height: 1px;
		    background: rgb(200,200,200);		 		    
		}

		paper-radio-button {
	      --paper-radio-button-checked-color: rgb(258,68,19);
	      --paper-radio-button-checked-ink-color: rgb(258,68,19);
	      --paper-radio-button-unchecked-color: var(--paper-orange-900);
	      --paper-radio-button-unchecked-ink-color: var(--paper-orange-900);
	    }

		.searchWrapper {			
			width: 100%;
			text-align: center;
			margin-top: 30px;
		}		

		.wrapperCity {
			@apply(--layout-horizontal);			
			@apply(--layout-center-justified);
		}		

		.wrapperCity .icCity {
			margin: 20px;
		}

		#btnSelCity {
			width: 150px;
			margin-top: 15px;			
		}		
		
		.wrapperDate {
			@apply(--layout-horizontal);			
			@apply(--layout-center-justified);
		}

		.wrapperDate .icDate {
			margin: 20px;
		}

		.wrapperDate paper-input {
			margin-right: 20px;
		}

		iron-selector > * {
        	padding: 8px;
        	width: 60px;
      	}      	

      	#rgTheme {
			font-size: 13px;			
			@apply(--layout-horizontal);	
			@apply(--layout-center-justified);
		}

		#rgTheme .imgDining {
			background-image: url("../../images/main/dining_icon_1.png");
			background-size: cover;
			background-repeat: no-repeat;	
			width: 36px;
			height: 32px;
		}
		#rgTheme .iron-selected .imgDining {
			background-image: url("../../images/main/dining_icon_2.png");
		}

		#rgTheme .imgParty {
			background-image: url("../../images/main/party_icon_1.png");
			background-size: cover;
			background-repeat: no-repeat;	
			width: 36px;
			height: 36px;
		}
		#rgTheme .iron-selected .imgParty {
			background-image: url("../../images/main/party_icon_2.png");
		}

		#rgTheme .imgAccompany {
			background-image: url("../../images/main/accompany_icon_1.png");
			background-size: cover;
			background-repeat: no-repeat;	
			width: 38px;
			height: 32px;
		}
		#rgTheme .iron-selected .imgAccompany {
			background-image: url("../../images/main/accompany_icon_2.png");
		}

		#btnSearch {
			height: 60px;
			margin-top: 30px;
			margin-bottom: 30px;
		}

      	.search-result{
      		margin: 10px;
      		margin-top: 25px;
      	}

		.travelBox {
			@apply(--layout-horizontal);				
		}

		.travelBox .userpic {
			cursor: pointer;
		}

		.travelBox .scheduleTitle {
			margin-left: 15px;
			font-size: 15px;
			font-weight: bold;
		}

		.travelBox .userinfoWrapper {
			@apply(--layout-horizontal);				
		}

		.travelBox .userinfoWrapper .icGender {
			margin-left: 15px;
			margin-right: 10px;
		}

		.travelBox .userinfoWrapper .name {
			margin-top: 3px;
		}

		.travelBox .userinfoWrapper .age {
			margin: 3px;
		}

		.travelBox .userinfoWrapper .nationality {
			margin: 3px;
		}
			
		.travelBox .themeWrapper {			
			@apply(--layout-horizontal);					
		}	

		.travelBox .themeWrapper .themes {
			margin: 15px;
		}

		.travelBox .themeWrapper #btnRequest {
			position: absolute;
			right: 15px;
		}
		
	</style>
	<template>

	    <firebase-collection	  
			id="fcRequests"        
          location="https://flamingo365.firebaseio.com/requests"
          ></firebase-collection>	           
	    	    
			<paper-material elevation="1">
				<div class="searchWrapper">
					<div class="vertical-section">
						<h2>City</h2>
						<div class="wrapperCity">
							<iron-icon class="icCity" src="../../images/main/nationality_icon.png"></iron-icon>
							<paper-input id="piSelCity" data-dialog="dlogCity" label="Select City" on-tap="showCityDlog"><paper-input>
						</div>
					</div>
					<div class="vertical-section">											
						<h2>Date</h2>			
						<div class="wrapperDate">
							<iron-icon class="icDate" src="../../images/main/calendar_icon_2.png"></iron-icon>
							<paper-input id="piPickDate" label="Select Start Date" on-tap="showDateDlog"></paper-input>				
						</div>
					</div>

					<div class="vertical-section">
						<h2>Theme</h2>
						<paper-radio-group id="rgTheme" selected="party">
							<paper-radio-button name="dining" noink><div class="imgDining"></div>Dining</paper-radio-button>
							<paper-radio-button name="party" noink><div class="imgParty"></div>Party</paper-radio-button>
							<paper-radio-button name="accompany" noink><div class="imgAccompany"></div>Accompany</paper-radio-button>				
						</paper-radio-group>
					</div>
							

					<div class="vertical-section">
						<paper-button id="btnSearch" on-tap="search" noink><iron-image src="../../images/main/searching_btn_2.png"></iron-image></paper-button>				
					</div>
				</div>
			</paper-material>

			<div class="vertical-section search-result">			

				<template is="dom-repeat" items="[[schedules]]" filter="filterStatus" sort="_sort" as="schedule">					
					<div class="travelBox">						
						<iron-image class="userpic" src="[[schedule.userpic]]" data-schedule-userid$="{{schedule.userid}}" style="width:90px; height:90px;" on-tap="moveProfile"></iron-image>
						<div class="vertical-section">
							<div class="scheduleTitle">[[schedule.schedule_title]]</div>
							<div class="userinfoWrapper">
								<iron-icon class="icGender" src="{{_computeUserGender(schedule.usergender)}}"></iron-icon>
								<div class="name">[[schedule.username]]</div>
								<div class="age">, [[_computeUserAge(schedule.userbirth)]]</div>		
								<div class="nationality">/ [[schedule.usernationality]]</div>
							</div>
							<div class="themeWrapper">
								<div class="themes"><iron-image src="{{_computeThemeImg(schedule.themeIdx)}}"></iron-image></div>								
								<paper-button id="btnRequest" on-tap="request" hidden$="{{checkData(schedule.userid)}}"
									data-key$="{{schedule.__firebaseKey__}}" 
									data-schedule-userid$="{{schedule.userid}}"
									data-schedule-usergender$="{{schedule.usergender}}"				
									data-schedule-username$="{{schedule.username}}"
									data-schedule-userpic$="{{schedule.userpic}}"								
									data-schedule-title$="{{schedule.schedule_title}}">
								 	<iron-image src="../../images/main/request_btn.png"></iron-image>
								</paper-button>
							</div>							
						</div>
					</div>				

					<hr />
				</template>				
			</div>
		</div>		

		<city-dialog id="cityDlog" on-select-city="onSelectCity"></city-dialog>


		<paper-dialog id="dpDlog" class="paper-date-picker-dialog" on-iron-overlay-closed="dateValueChanged">
			<div class="buttons">
	          <paper-button dialog-dismiss>Cancel</paper-button>
	          <paper-button dialog-confirm>OK</paper-button>
	        </div>
	        <paper-date-picker id="datePicker" date="{{pickerDate}}" responsive-width="655px"></paper-date-picker>	        
	      </paper-dialog>
	</template>
</dom-module>
<script>
	Polymer({
		is: "finding-travelers",

		properties: {		

			userid: {
				type: String,				
				observer: '_useridChanged'
			},

			userData: Object,

			schedules: Object,

			selCityIdx: {
				type: Number,
				value: -1
			},		

			pickerDate: {
				type: Number,
				observer: '_pickerDateChanged'
			},	

			pickDate: {
				type: Number,
				value: -1
			},

			isShow: {
				type: Boolean,
				value: false				
			},

			themeIdx: {
				type: Number,
				value: 0
			}			
		},		

		ready: function() {	
			//default london		
			this.selCityIdx = 1;
			var strName = "London";
			this.$.piSelCity.value = strName;	

			// this.search();			
		},

		_useridChanged: function() {
			if(this.userid!=""){			
				var that = this;						 
				var ref = new Firebase("https://flamingo365.firebaseio.com/users");	    
				ref.child(this.userid).once("value", function(snap) {					
					that.userData = snap.val();						
				});
			}	
		},		

		filterStatus: function(item) {			
			if(this.themeIdx==0){
				return item.status == 0;
			} else {
				return item.status == 0 && item.themeIdx == this.themeIdx;
			}			
		},

		_sort: function(a, b) {			
			return a.startDate > b.startDate ? 1 : -1;
		},
		
		showCityDlog: function() {			
			this.$.cityDlog.open();
		},

		showDateDlog: function() {			
			this.$.dpDlog.open();
		},

		
		_pickerDateChanged: function() {
			this.$.dpDlog.close();
			this.dateValueChanged();
		},

		dateValueChanged: function() {			
			var date = this.$.datePicker.date;
			if(date==null){
				return;
			}
						
			var year = this.$.datePicker.dateFormat(date, 'YYYY');
			var month = this.$.datePicker.dateFormat(date, 'MMM');
			var day = this.$.datePicker.dateFormat(date, 'D');
			
			var strDate = year+" "+month+" "+day;

			this.$.piPickDate.value = strDate;
			this.pickDate = date.getTime();    			    		
		},

		onSelectCity: function(e) {			
			this.selCityIdx = e.detail.idx;
			var strName = e.detail.name;
			this.$.piSelCity.value = strName;			
		},		
		
		search: function() {							
			var selCityIdx = this.selCityIdx;
			var pickDate = this.pickDate;			
						
			var that = this;
			
			var ref = new Firebase("https://flamingo365.firebaseio.com/schedules");					
			if(selCityIdx!=-1 && pickDate!=-1){						
				ref.orderByChild("selCityIdx").on("value", function(querySnapshot) {
					that.schedules = [];				

					querySnapshot.forEach(function(snapshot) {						
						if(snapshot.val().selCityIdx==selCityIdx && snapshot.val().startDate <= pickDate && pickDate < snapshot.val().startDate+86400000){							
							var sv = snapshot.val();							
							sv["__firebaseKey__"] = snapshot.key();									
							that.push('schedules', sv);							
						}
					});									
				});							
			} else if(selCityIdx!=-1){				
				ref.orderByChild("selCityIdx").on("value", function(querySnapshot) {					

					that.schedules = [];				
					querySnapshot.forEach(function(snapshot) {						
						if(snapshot.val().selCityIdx==selCityIdx && snapshot.val().startDate>=Date.now()){
							var sv = snapshot.val();							
							sv["__firebaseKey__"] = snapshot.key();					
							that.push('schedules', sv);							
						}						
					});
				});
			}			
		},

		_computeUserGender: function(gender) {
			if(gender==="male"){
				return "../../images/main/male_imae.png";
			} else {
				return "../../images/main/female_imae.png";
			}
		},

		_computeUserAge: function(birth) {
			if(birth==null){
				return "";
			}
			
			var date = new Date(birth);
			var ageDate = new Date(Date.now()-date.getTime());
			return Math.abs(ageDate.getFullYear()-1970);
		},

		_computeThemeImg: function(themeIdx) {
			if(themeIdx == 1){
				return "../../images/main/dining_icon.png";
			} else if(themeIdx == 2){
				return "../../images/main/party_icon.png";
			} else if(themeIdx == 3){
				return "../../images/main/accompany_icon.png";
			}
		},

		checkData: function(suserid) {						
			if(this.userid==suserid){
				return true;
			}

			return false;
		},

		moveProfile: function(e) {
			var userid = e.currentTarget.getAttribute("data-schedule-userid");
			page.redirect("/profile/"+userid);
		},

		request: function(e) {						
			var schedule_id = e.currentTarget.getAttribute("data-key");
			var schedule_title = e.currentTarget.getAttribute("data-schedule-title");
			var schedule_userid = e.currentTarget.getAttribute("data-schedule-userid");
			var schedule_usergender = e.currentTarget.getAttribute("data-schedule-usergender");
			var schedule_username = e.currentTarget.getAttribute("data-schedule-username");			
			var schedule_userpic = e.currentTarget.getAttribute("data-schedule-userpic");			

			if(this.userid==schedule_userid){
				alert("It's impossible to request its user");
				return;
			}

			var data = {
				schedule_id: schedule_id,
				schedule_title: schedule_title,
				schedule_userid: schedule_userid,
				schedule_usergender: schedule_usergender,
				schedule_username: schedule_username,				
				schedule_userpic: schedule_userpic,
				userid: this.userid,
				username: this.userData.username,
				usergender: this.userData.gender,				
				userpic: this.userData.picture,
				status: 0,
				created_at: new Date().getTime()				
			};
			this.$.fcRequests.add(data);
			// this.fire('show-dialog', {content: "Request has sent.",url: "/search"});
			alert("Request has sent.");
		}
	});
</script>